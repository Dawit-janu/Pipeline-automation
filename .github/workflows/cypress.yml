name: Cypress Automation Test

on:
  push:
    branches: [ main ]

  pull_request:

  workflow_dispatch:

  # ‚úÖ STEP 2 ‚Äî SCHEDULER (DITAMBAHKAN DI SINI)
  schedule:
   #- cron: '0 1 * * *'   # 08:00 WIB (UTC+7)
   #- cron: '40 20 * * *'
     - cron: '*/5 * * * *'



jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ‚úÖ Detect trigger
      - name: Detect trigger
        run: echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV

      # ‚úÖ Dependencies
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install project dependencies
        run: npm ci

      # ============================================================
      # ‚úÖ RUN CYPRESS
      # --record  ‚Üí kirim ke Cypress Cloud dashboard (video, screenshot, history)
      # --reporter ‚Üí generate mochawesome JSON untuk summary Discord
      # ============================================================
      - name: Run Cypress Tests
        continue-on-error: true
        run: |
          mkdir -p results allure-results
          npx cypress run \
            --record \
            --key ${{ secrets.CYPRESS_RECORD_KEY }} \
            --reporter mochawesome \
            --reporter-options "reportDir=results,overwrite=false,html=false,json=true"
        env:
          allure: true
          allureResultsPath: allure-results

      # ============================================================
      # ‚úÖ MOCHAWESOME ‚Äî merge JSON jadi 1 file untuk parsing summary
      # ============================================================
      - name: Remove empty mochawesome files
        if: always()
        run: find results -type f -name "*.json" -size 0 -delete || true

      - name: Merge mochawesome reports
        if: always()
        run: |
          if ls results/mochawesome_*.json 1> /dev/null 2>&1; then
            npx mochawesome-merge results/mochawesome_*.json > results/mochawesome.json
            echo "‚úÖ Mochawesome merged"
            cat results/mochawesome.json | jq '.stats'
          else
            echo "‚ö†Ô∏è No mochawesome files, creating fallback"
            echo '{"stats":{"tests":0,"passes":0,"failures":0,"pending":0,"duration":0},"results":[]}' \
              > results/mochawesome.json
          fi

      # ============================================================
      # ‚úÖ ALLURE ‚Äî generate report, simpan sebagai artifact 30 hari
      # Download dari: Actions tab ‚Üí pilih run ‚Üí Artifacts section
      # ============================================================
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline
          if [ -d allure-results ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            allure generate allure-results --clean -o allure-report
            echo "‚úÖ Allure report generated"
          else
            echo "‚ö†Ô∏è No allure results, skipping"
          fi

      - name: Upload Allure Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-run-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      # ============================================================
      # ‚úÖ EXTRACT SUMMARY untuk Discord notification
      # ============================================================
      - name: Extract test summary
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then
            TOTAL_TESTS=$(jq '.stats.tests'         results/mochawesome.json)
            FAILED_TESTS=$(jq '.stats.failures'     results/mochawesome.json)
            PASSED_TESTS=$(jq '.stats.passes'       results/mochawesome.json)
            PENDING_TESTS=$(jq '.stats.pending // 0' results/mochawesome.json)
            DURATION_MS=$(jq '.stats.duration'      results/mochawesome.json)
          else
            TOTAL_TESTS=0; FAILED_TESTS=0; PASSED_TESTS=0; PENDING_TESTS=0; DURATION_MS=0
          fi

          DURATION_SEC=$((DURATION_MS / 1000))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))

          echo "TOTAL_TESTS=$TOTAL_TESTS"             >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS"           >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS"           >> $GITHUB_ENV
          echo "PENDING_TESTS=$PENDING_TESTS"         >> $GITHUB_ENV
          echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV

      - name: Extract failed tests
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then
            FAILED_TEST_DETAILS=$(jq -r '
              .results[].suites[].tests[]
              | select(.fail == true)
              | "- " + .fullTitle
            ' results/mochawesome.json 2>/dev/null || echo "")
          else
            FAILED_TEST_DETAILS=""
          fi
          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS"     >> $GITHUB_ENV
          echo "EOF"                      >> $GITHUB_ENV

      # ============================================================
      # ‚úÖ DISCORD NOTIFICATION
      # Link langsung ke Cypress Cloud + Allure artifact
      # ============================================================
      - name: Send Discord Notification
        if: always()
        run: |
          # Status & color
          if [ "$FAILED_TESTS" != "0" ] && [ "$FAILED_TESTS" != "null" ]; then
            STATUS="FAILED"; COLOR=15158332; ICON="‚ùå"
          else
            STATUS="SUCCESS"; COLOR=3066993; ICON="‚úÖ"
          fi

          # Trigger label
          case "$TRIGGER" in
            schedule)          TRIGGER_LABEL="‚è∞ Scheduled" ;;
            push)              TRIGGER_LABEL="üöÄ Push" ;;
            pull_request)      TRIGGER_LABEL="üîÄ Pull Request" ;;
            workflow_dispatch) TRIGGER_LABEL="üñê Manual" ;;
            *)                 TRIGGER_LABEL="$TRIGGER" ;;
          esac

          # URLs
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CLOUD_URL="https://cloud.cypress.io/projects/wipkva/runs"
          ARTIFACT_URL="${RUN_URL}#artifacts"

          jq -n \
            --arg trigger      "$TRIGGER_LABEL" \
            --arg runNumber    "${{ github.run_number }}" \
            --arg runAttempt   "${{ github.run_attempt }}" \
            --arg repo         "${{ github.repository }}" \
            --arg branch       "${{ github.ref_name }}" \
            --arg status       "$STATUS" \
            --arg total        "$TOTAL_TESTS" \
            --arg passed       "$PASSED_TESTS" \
            --arg failed       "$FAILED_TESTS" \
            --arg pending      "$PENDING_TESTS" \
            --arg duration     "$TEST_DURATION" \
            --arg runUrl       "$RUN_URL" \
            --arg cloudUrl     "$CLOUD_URL" \
            --arg artifactUrl  "$ARTIFACT_URL" \
            --arg icon         "$ICON" \
            --arg failedList   "$FAILED_TEST_DETAILS" \
            --argjson color    $COLOR \
          '{
            embeds: [{
              title: "üß™ Cypress Automation Report",
              url: $runUrl,
              color: $color,
              fields: [
                { name: "Trigger",           value: $trigger,                                              inline: true  },
                { name: "Test Run",          value: ("#" + $runNumber + " ¬∑ Attempt " + $runAttempt),     inline: true  },
                { name: "Duration",          value: ("‚è± " + $duration),                                   inline: true  },
                { name: "Repository",        value: $repo,                                                 inline: true  },
                { name: "Branch",            value: $branch,                                               inline: true  },
                { name: "Status",            value: ($icon + " " + $status),                              inline: true  },
                { name: "Total",             value: $total,                                                inline: true  },
                { name: "‚úÖ Passed",         value: $passed,                                               inline: true  },
                { name: "‚ùå Failed",         value: $failed,                                               inline: true  },
                { name: "‚è≠ Pending",        value: $pending,                                              inline: true  },
                { name: "‚òÅÔ∏è Cypress Cloud",  value: ("[Open Dashboard ‚Üí](" + $cloudUrl + ")"),            inline: true  },
                { name: "üì¶ Allure Report",  value: ("[Download Artifact ‚Üí](" + $artifactUrl + ")"),      inline: true  },
                {
                  name: "‚ùó Failed Tests",
                  value: ($failedList | if . == "" or . == null then "‚úÖ Semua test passed!" else . end)
                }
              ],
              footer: { text: "GitHub Actions ‚Ä¢ Cypress Cloud ‚Ä¢ Allure" },
              timestamp: (now | todateiso8601)
            }]
          }' \
          | curl -s -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}