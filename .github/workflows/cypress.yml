name: Cypress Automation Test

on:
  # üöÄ Push ke main ‚Üí trigger (merge dari QA branch setelah fix)
  push:
    branches: [ main ]

  # üîÄ Pull Request ke main ‚Üí trigger saat QA buat PR dari branch fix
  pull_request:
    branches: [ main ]

  # üñê Manual trigger
  workflow_dispatch:

  # ‚úÖ STEP 2 ‚Äî SCHEDULER (DITAMBAHKAN DI SINI)
  schedule:
   #- cron: '0 1 * * *'   # 08:00 WIB (UTC+7)
   #- cron: '40 20 * * *'
     #- cron: '0 18 * * 0-4'
      - cron: '*/5 * * * *'


jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect trigger & start time
        run: |
          echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV
          echo "JOB_START_TIME=$(date +%s)"       >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install project dependencies
        run: npm ci

      # ============================================================
      # RUN CYPRESS
      # ============================================================
      - name: Run Cypress Tests
        continue-on-error: true
        run: |
          npx cypress run \
            --record \
            --key ${{ secrets.CYPRESS_RECORD_KEY }} \
            2>&1 | tee cypress-raw.txt

      - name: Strip ANSI color codes
        if: always()
        run: sed 's/\x1B\[[0-9;]*[mKHF]//g' cypress-raw.txt > cypress-output.txt

      # ============================================================
      # ALLURE
      # ============================================================
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline --quiet
          if [ -d allure-results ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            allure generate allure-results --clean -o allure-report
          fi

      - name: Upload Allure Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      # ============================================================
      # EXTRACT STATS
      # ============================================================
      - name: Extract test summary
        if: always()
        run: |
          # Duration
          JOB_END_TIME=$(date +%s)
          DURATION_SEC=$(( JOB_END_TIME - JOB_START_TIME ))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))

          # Parse baris summary tabel Cypress:
          # "‚úî  All specs passed!         00:09    3    3    -    -    -"
          # "‚úñ  1 of 3 failed (33%)       00:11    3    2    1    -    -"
          # 5 kolom terakhir: Tests Passing Failing Pending Skipped
          SUMMARY_LINE=$(grep -E '(All specs passed|of [0-9]+ failed)' cypress-output.txt | tail -1)
          echo "=== SUMMARY LINE: $SUMMARY_LINE ==="

          if [ -n "$SUMMARY_LINE" ]; then
            CLEAN=$(echo "$SUMMARY_LINE" | sed 's/[^0-9 \t-]//g' | tr -s ' \t' ' ' | sed 's/^ //')
            echo "=== CLEAN: $CLEAN ==="
            FIELD_COUNT=$(echo "$CLEAN" | awk '{print NF}')
            TOTAL=$(echo "$CLEAN"   | awk -v n=$FIELD_COUNT '{print $(n-4)}' | sed 's/-/0/')
            PASSING=$(echo "$CLEAN" | awk -v n=$FIELD_COUNT '{print $(n-3)}' | sed 's/-/0/')
            FAILING=$(echo "$CLEAN" | awk -v n=$FIELD_COUNT '{print $(n-2)}' | sed 's/-/0/')
            PENDING=$(echo "$CLEAN" | awk -v n=$FIELD_COUNT '{print $(n-1)}' | sed 's/-/0/')
          fi

          TOTAL=${TOTAL:-0}
          PASSING=${PASSING:-0}
          FAILING=${FAILING:-0}
          PENDING=${PENDING:-0}

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSING * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0"
          fi

          # TS folder name ‚Äî ambil dari struktur folder e2e di repo
          # Struktur: cypress/e2e/TS-xxx/TC01.cy.js ‚Üí ambil folder TS-xxx
          TS_NAME=$(find cypress/e2e -mindepth 1 -maxdepth 1 -type d -name "TS-*"             | sed 's|.*/||' | sort | sed 's/^/‚Ä¢ /')
          TS_NAME=${TS_NAME:-"‚Ä¢ e2e"}
          echo "=== TS_NAME: $TS_NAME ==="

          echo "TOTAL_TESTS=$TOTAL"                    >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSING"                 >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILING"                 >> $GITHUB_ENV
          echo "PENDING_TESTS=$PENDING"                >> $GITHUB_ENV
          echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV
          echo "PASS_RATE=${PASS_RATE}%"               >> $GITHUB_ENV
          echo "TS_NAME=$TS_NAME"                      >> $GITHUB_ENV

          echo "Total=$TOTAL | Passed=$PASSING | Failed=$FAILING | TS=$TS_NAME"

      - name: Extract failed test details
        if: always()
        run: |
          # Ambil Cypress Cloud run URL dari output
          # Cypress print: "Recorded Run: https://cloud.cypress.io/projects/xxx/runs/104"
          CYPRESS_RUN_URL=$(grep -oE 'https://cloud\.cypress\.io/projects/[^[:space:]]+/runs/[0-9]+' cypress-output.txt | head -1)
          echo "=== CYPRESS RUN URL: $CYPRESS_RUN_URL ==="

          # Build test-results URL
          TEST_RESULTS_URL="${CYPRESS_RUN_URL}/test-results?actions=%5B%5D&browsers=%5B%5D&groups=%5B%5D&isFlaky=%5B%5D&modificationDateRange=%7B%22startDate%22%3A%221970-01-01%22%2C%22endDate%22%3A%222038-01-19%22%7D&orderBy=EXECUTION_ORDER&oses=%5B%5D&specs=%5B%5D&statuses=%5B%5D&testingTypesEnum=%5B%5D"

          # Fallback jika URL tidak ditemukan
          if [ -z "$CYPRESS_RUN_URL" ]; then
            TEST_RESULTS_URL="https://cloud.cypress.io/projects/wipkva/runs"
          fi

          echo "CYPRESS_RUN_URL=$CYPRESS_RUN_URL"   >> $GITHUB_ENV
          echo "TEST_RESULTS_URL=$TEST_RESULTS_URL" >> $GITHUB_ENV

          # Ambil failed specs dari tabel (baris dengan ‚úñ)
          # Format tabel: "‚îÇ ‚úñ  TS-itera/TC01-Dashboard.cy.js  ..."
          # Kita ambil path lengkap termasuk folder TS
          FAILED_SPECS=$(grep -E "‚îÇ\s+‚úñ" cypress-output.txt             | grep -oE "[A-Za-z0-9_/-]+\.cy\.js"             | sed "s/\.cy\.js$//"             | sort -u)

          # Fallback: jika tidak ada path lengkap, coba tanpa folder
          if [ -z "$FAILED_SPECS" ]; then
            FAILED_SPECS=$(grep -E "‚úñ" cypress-output.txt               | grep "\.cy\.js"               | grep -oE "[A-Za-z0-9_/-]+\.cy\.js"               | sed "s/\.cy\.js$//"               | sort -u)
          fi

          echo "=== FAILED SPECS: $FAILED_SPECS ==="

          # Parse describe + test title dari section failing
          # Format Cypress:
          #   1) Describe Name
          #        test title
          FAILED_TESTS_PARSED=$(awk '
            /^[[:space:]]+[0-9]+\)/ { in_block=1; describe_line=""; test_line=""; next }
            in_block==1 && /^[[:space:]]+[A-Za-z]/ && describe_line=="" {
              line=$0; gsub(/^[[:space:]]+/, "", line); describe_line=line; next
            }
            in_block==1 && /^[[:space:]]+[A-Za-z]/ && describe_line!="" && test_line=="" {
              line=$0; gsub(/^[[:space:]]+/, "", line); gsub(/:$/, "", line)
              test_line=line; print describe_line "|" test_line; in_block=0
            }
            /^[[:space:]]*$/ && in_block==1 { in_block=0 }
          ' cypress-output.txt)

          echo "=== FAILED TESTS PARSED ==="
          echo "$FAILED_TESTS_PARSED"

          echo "FAILED_SPECS<<EOF"         >> $GITHUB_ENV
          echo "$FAILED_SPECS"             >> $GITHUB_ENV
          echo "EOF"                       >> $GITHUB_ENV

          echo "FAILED_TESTS_PARSED<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TESTS_PARSED"     >> $GITHUB_ENV
          echo "EOF"                      >> $GITHUB_ENV

      # ============================================================
      # DISCORD NOTIFICATION
      # ============================================================
      - name: Send Discord Notification
        if: always()
        run: |
          DATE_RUN=$(TZ='Asia/Jakarta' date "+%Y-%m-%d %H:%M:%S WIB")

          TOTAL=${TOTAL_TESTS:-0}
          PASSED=${PASSED_TESTS:-0}
          FAILED=${FAILED_TESTS:-0}
          PENDING=${PENDING_TESTS:-0}

          if [ "$FAILED" != "0" ]; then
            STATUS_TEXT="has failed"
            RESULT_ICON="‚ùå"
            COLOR=15158332
          else
            STATUS_TEXT="has passed"
            RESULT_ICON="‚úÖ"
            COLOR=3066993
          fi

          case "$TRIGGER" in
            schedule)          TRIGGER_LABEL="Scheduled"    ;;
            push)              TRIGGER_LABEL="Push to main" ;;
            pull_request)      TRIGGER_LABEL="Pull Request" ;;
            workflow_dispatch) TRIGGER_LABEL="Manual"       ;;
            *)                 TRIGGER_LABEL="$TRIGGER"     ;;
          esac

          if [ "$TRIGGER" = "pull_request" ]; then
            BRANCH_INFO="PR #${{ github.event.pull_request.number }} (${{ github.head_ref }})"
          else
            BRANCH_INFO="${{ github.ref_name }}"
          fi

          CLOUD_URL="https://cloud.cypress.io/projects/wipkva/runs"
          # Gunakan run URL spesifik jika ada
          if [ -n "$CYPRESS_RUN_URL" ]; then
            DISPLAY_URL="$CYPRESS_RUN_URL"
          else
            DISPLAY_URL="$CLOUD_URL"
          fi
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPO="${{ github.repository }}"
          REPO_NAME="${REPO##*/}"
          TS="${TS_NAME:-e2e}"

          # Build failed section ‚Äî tampilkan spec name saja, klik ‚Üí test-results
          FAILED_SECTION=""
          if [ "$FAILED" != "0" ]; then
            FAILED_SECTION="**${FAILED} test results failed**"

            if [ -n "$FAILED_SPECS" ]; then
              while IFS= read -r spec_name; do
                [ -z "$spec_name" ] && continue
                FAILED_SECTION="${FAILED_SECTION}
          - [${spec_name}](${TEST_RESULTS_URL})"
                        done <<< "$FAILED_SPECS"
                      fi
                    fi

          # Judul dan body
          TITLE="Automation Report Cypress"
          DESC="Test Run [#${{ github.run_number }}](${CLOUD_URL}) of the **${REPO_NAME}** ${STATUS_TEXT}."

          BODY="${DESC}

          üì¶ ${TS}
          üóì ${DATE_RUN}
          ‚è± Duration : ${TEST_DURATION}
          ${RESULT_ICON} Test results : ${TOTAL} test results
          ‚úÖ Passed : ${PASSED}
          ‚ùå Failed : ${FAILED}"

          if [ -n "$FAILED_SECTION" ]; then
            BODY="${BODY}

          ${FAILED_SECTION}"
                    fi

          FOOTER="${REPO} | ${BRANCH_INFO} | ${TRIGGER_LABEL}"

          jq -n \
            --arg title  "$TITLE" \
            --arg body   "$BODY" \
            --arg footer "$FOOTER" \
            --arg url    "$DISPLAY_URL" \
            --argjson color $COLOR \
          '{
            embeds: [{
              title: $title,
              url: $url,
              description: $body,
              color: $color,
              footer: { text: $footer },
              timestamp: (now | todateiso8601)
            }]
          }' \
          | curl -s -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}