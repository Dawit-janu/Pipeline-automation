name: Cypress Automation Test (Docker)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  cypress-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t cypress-test .

      - name: Run Cypress tests (Docker)
        run: |
          mkdir -p results
          docker run --rm \
          -v ${{ github.workspace }}:/app \
          -w /app \
          cypress/included:13.6.6 \
          cypress run \
          --reporter json \
          --reporter-options output=/app/results/results.json \
          || echo "CYPRESS_FAILED=true" >> $GITHUB_ENV


      - name: Debug results folder
        if: always()
        run: |
          echo "=== results folder ==="
          ls -lah results || true


      # ‚úÖ STEP 6.3 ‚Äî HARUS DI SINI
      - name: Extract failed tests
        if: always()
        run: |
          if [ -f results/results.json ]; then
            FAILED_TEST_DETAILS=$(jq -r '
              .tests[] | select(.state=="failed") |
              "- " + .title
            ' results/results.json)
          else
            FAILED_TEST_DETAILS="No results.json found"
          fi

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # - name: Send Telegram Notification
      #   if: always()
      #   run: |
      #     TOTAL_TESTS=23
      #     FAILED_TESTS=3
      #     PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))

      #     if [ "$CYPRESS_FAILED" = "true" ]; then
      #       STATUS="‚ùå FAILED"
      #     else
      #       STATUS="‚úÖ SUCCESS"
      #     fi

      #     MESSAGE="Cypress Test Result:
      #     Repo: ${{ github.repository }}
      #     Branch: ${{ github.ref_name }}
      #     Status: $STATUS
      #     Total Tests: $TOTAL_TESTS
      #     Passed Tests: $PASSED_TESTS
      #     Failed Tests: $FAILED_TESTS
      #     Run: ${{ github.run_number }}
      #     "

      #     curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
      #     -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
      #     -d text="$MESSAGE"

      - name: Send Discord Embed Notification
        if: always()
        run: |
          TOTAL_TESTS=23
          FAILED_TESTS=3
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))

          if [ "$CYPRESS_FAILED" = "true" ]; then
            STATUS="FAILED"
            COLOR=15158332   # üî¥ red
            ICON="‚ùå"
          else
            STATUS="SUCCESS"
            COLOR=3066993    # üü¢ green
            ICON="‚úÖ"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          jq -n \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status "$STATUS" \
            --arg total "$TOTAL_TESTS" \
            --arg passed "$PASSED_TESTS" \
            --arg failed "$FAILED_TESTS" \
            --arg run "${{ github.run_number }}" \
            --arg url "$RUN_URL" \
            --arg icon "$ICON" \
            --argjson color $COLOR \
          '{
            embeds: [
              {
                title: "üß™ Cypress Automation Report",
                color: $color,
                fields: [
                  {name: "Repository", value: $repo, inline: true},
                  {name: "Branch", value: $branch, inline: true},
                  {name: "Status", value: ($icon + " " + $status), inline: true},
                  {name: "Total Tests", value: $total, inline: true},
                  {name: "Passed", value: $passed, inline: true},
                  {name: "Failed", value: $failed, inline: true},
                  {name: "Run Number", value: ("#" + $run), inline: true}
                ],
                url: $url,
                footer: {
                  text: "GitHub Actions ‚Ä¢ Cypress Automation"
                },
                timestamp: now | todate
              }
            ]
          }' \
              | curl -H "Content-Type: application/json" \
                  -X POST \
                  -d @- \
                  ${{ secrets.DISCORD_WEBHOOK }}
