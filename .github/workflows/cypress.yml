name: Cypress Automation Test (Docker)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  cypress-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ‚úÖ jq diperlukan untuk parsing JSON
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build Docker image
        run: docker build -t cypress-test .

      # ‚úÖ RUN CYPRESS + MOCHAWESOME
      - name: Run Cypress tests (Docker)
        continue-on-error: true
        run: |
          mkdir -p results
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            cypress/included:13.6.6 \
            cypress run \
            --reporter mochawesome \
            --reporter-options reportDir=results,overwrite=false,html=false,json=true

      - name: Debug results folder
        if: always()
        run: |
          echo "=== results folder ==="
          ls -lah results || true
      
      - name: Remove empty mochawesome files
        run: |
          find results -type f -name "*.json" -size 0 -delete

      - name: Merge mochawesome reports
        run: |
          ls results/mochawesome_*.json
          npx mochawesome-merge results/mochawesome_*.json \
          > results/mochawesome.json

      - name: Debug merged report
        run: cat results/mochawesome.json | jq '.stats'


      # ‚úÖ EXTRACT SUMMARY (AUTO COUNT)
      - name: Extract test summary
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then

            TOTAL_TESTS=$(jq '
              .stats.tests //
              .results[0].stats.tests //
              0
            ' results/mochawesome.json)

            FAILED_TESTS=$(jq '
              .stats.failures //
              .results[0].stats.failures //
              0
            ' results/mochawesome.json)

            PASSED_TESTS=$(jq '
              .stats.passes //
              .results[0].stats.passes //
              0
            ' results/mochawesome.json)

          else
            TOTAL_TESTS=0
            FAILED_TESTS=0
            PASSED_TESTS=0
          fi

          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV


      # ‚úÖ EXTRACT FAILED TEST LIST (FIXED QUERY)
      - name: Extract failed tests
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then
            FAILED_TEST_DETAILS=$(jq -r '
              .results[].suites[].tests[]
              | select(.fail == true)
              | "- " + .fullTitle
            ' results/mochawesome.json)
          else
            FAILED_TEST_DETAILS="None"
          fi

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # - name: Send Telegram Notification
      #   if: always()
      #   run: |
      #     TOTAL_TESTS=23
      #     FAILED_TESTS=3
      #     PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))

      #     if [ "$CYPRESS_FAILED" = "true" ]; then
      #       STATUS="‚ùå FAILED"
      #     else
      #       STATUS="‚úÖ SUCCESS"
      #     fi

      #     MESSAGE="Cypress Test Result:
      #     Repo: ${{ github.repository }}
      #     Branch: ${{ github.ref_name }}
      #     Status: $STATUS
      #     Total Tests: $TOTAL_TESTS
      #     Passed Tests: $PASSED_TESTS
      #     Failed Tests: $FAILED_TESTS
      #     Run: ${{ github.run_number }}
      #     "

      #     curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
      #     -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
      #     -d text="$MESSAGE"

       # ‚úÖ SEND DISCORD EMBED (SLACK STYLE)
      - name: Send Discord Embed Notification
        if: always()
        run: |

          # AUTO STATUS
          if [ "$FAILED_TESTS" != "0" ]; then
            STATUS="FAILED"
            COLOR=15158332
            ICON="‚ùå"
          else
            STATUS="SUCCESS"
            COLOR=3066993
            ICON="‚úÖ"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          jq -n \
            --arg runNumber "${{ github.run_number }}" \
            --arg runAttempt "${{ github.run_attempt }}" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status "$STATUS" \
            --arg total "$TOTAL_TESTS" \
            --arg passed "$PASSED_TESTS" \
            --arg failed "$FAILED_TESTS" \
            --arg url "$RUN_URL" \
            --arg icon "$ICON" \
            --arg failedDetails "$FAILED_TEST_DETAILS" \
            --argjson color $COLOR \
          '{
            embeds: [
              {
                title: "üß™ Cypress Automation Report",
                url: $url,
                color: $color,
                fields: [
                  {name: "Test Run", value : ("#"+ runNumber + " (Attempt "+ $runAttempt + ")"), inline: true},
                  {name: "Repository", value: $repo, inline: true},
                  {name: "Branch", value: $branch, inline: true},
                  {name: "Status", value: ($icon + " " + $status), inline: true},
                  {name: "Total Tests", value: $total, inline: true},
                  {name: "Passed", value: $passed, inline: true},
                  {name: "Failed", value: $failed, inline: true},
                  {
                    name: "‚ùó Failed Tests",
                    value: ($failedDetails | if . == "" then "None" else . end)
                  }
                ],
                footer: {
                  text: "GitHub Actions ‚Ä¢ Cypress Automation"
                },
                timestamp: (now | todateiso8601)
              }
            ]
          }' \
          | curl -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}

