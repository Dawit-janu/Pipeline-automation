name: Cypress Automation Test (Docker)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  cypress-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t cypress-test .

      - name: Run Cypress tests (Docker)
        run: |
          mkdir -p results
          docker run --rm \
          -v ${{ github.workspace }}:/app \
          -w /app \
          cypress/included:13.6.6 \
          cypress run \
          --reporter json \
          --reporter-options output=/app/results/results.json \
          || echo "CYPRESS_FAILED=true" >> $GITHUB_ENV


      - name: Debug results folder
        if: always()
        run: |
          echo "=== results folder ==="
          ls -lah results || true


      # ✅ STEP 6.3 — HARUS DI SINI
      - name: Extract failed tests
        if: always()
        run: |
          if [ -f results/results.json ]; then
            FAILED_TEST_DETAILS=$(jq -r '
              .tests[] | select(.state=="failed") |
              "- " + .title
            ' results/results.json)
          else
            FAILED_TEST_DETAILS="No results.json found"
          fi

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # - name: Send Telegram Notification
      #   if: always()
      #   run: |
      #     TOTAL_TESTS=23
      #     FAILED_TESTS=3
      #     PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))

      #     if [ "$CYPRESS_FAILED" = "true" ]; then
      #       STATUS="❌ FAILED"
      #     else
      #       STATUS="✅ SUCCESS"
      #     fi

      #     MESSAGE="Cypress Test Result:
      #     Repo: ${{ github.repository }}
      #     Branch: ${{ github.ref_name }}
      #     Status: $STATUS
      #     Total Tests: $TOTAL_TESTS
      #     Passed Tests: $PASSED_TESTS
      #     Failed Tests: $FAILED_TESTS
      #     Run: ${{ github.run_number }}
      #     "

      #     curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
      #     -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
      #     -d text="$MESSAGE"

      - name: Send Discord Notification
        if: always()
        run: |
          TOTAL_TESTS=23
          FAILED_TESTS=3
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))

          if [ "$CYPRESS_FAILED" = "true" ]; then
            STATUS="❌ FAILED"
          else
            STATUS="✅ SUCCESS"
          fi

          MESSAGE="**Cypress Test Result (Docker)**
          Repo: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Status: $STATUS
          Total Tests: $TOTAL_TESTS
          Passed Tests: $PASSED_TESTS
          Failed Tests: $FAILED_TESTS
          Run: ${{ github.run_number }}"

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\":\"$MESSAGE\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
