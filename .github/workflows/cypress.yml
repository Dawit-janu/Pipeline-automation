name: Cypress Automation Test

on:
  # üöÄ Push ke main ‚Üí trigger (merge dari QA branch setelah fix)
  push:
    branches: [ main ]

  # üîÄ Pull Request ke main ‚Üí trigger saat QA buat PR dari branch fix
  pull_request:
    branches: [ main ]

  # üñê Manual trigger
  workflow_dispatch:

  # ‚úÖ STEP 2 ‚Äî SCHEDULER (DITAMBAHKAN DI SINI)
  schedule:
   #- cron: '0 1 * * *'   # 08:00 WIB (UTC+7)
   #- cron: '40 20 * * *'
     #- cron: '0 18 * * 0-4'
      - cron: '*/5 * * * *'


jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ‚úÖ Detect trigger + catat waktu start
      - name: Detect trigger
        run: |
          echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV
          echo "JOB_START_TIME=$(date +%s)" >> $GITHUB_ENV

      # ‚úÖ Dependencies
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install project dependencies
        run: npm ci

      # ============================================================
      # ‚úÖ RUN CYPRESS
      # ============================================================
      # Bersihkan folder lama di step terpisah agar tidak konflik
      - name: Clean results folder
        run: |
          rm -rf results allure-results
          mkdir -p results allure-results
          # CI_BUILD_ID unik per run
          echo "CI_BUILD_ID=${{ github.repository }}-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_ENV

      - name: Run Cypress Tests
        id: cypress
        run: |
          set +e

          npx cypress run \
            --record \
            --key ${{ secrets.CYPRESS_RECORD_KEY }} \
            | tee cypress-output.txt

          CYPRESS_EXIT_CODE=${PIPESTATUS[0]}
          echo "CYPRESS_EXIT_CODE=$CYPRESS_EXIT_CODE" >> $GITHUB_ENV

      # ============================================================
      # ‚úÖ MOCHAWESOME ‚Äî merge JSON jadi 1 file untuk parsing summary
      # ============================================================
      # - name: Remove empty mochawesome files
      #   if: always()
      #   run: find results -type f -name "*.json" -size 0 -delete || true

      # - name: Merge mochawesome reports
      #   if: always()
      #   run: |
      #     echo "=== File di results/ ==="
      #     ls -lah results/ || echo "folder kosong"

      #     JSON_FILES=$(find results -name "mochawesome_*.json" -size +0c 2>/dev/null)
      #     echo "=== JSON files ditemukan ==="
      #     echo "$JSON_FILES"

      #     if [ -n "$JSON_FILES" ]; then
      #       npx mochawesome-merge results/mochawesome_*.json > results/mochawesome.json
      #       echo "‚úÖ Mochawesome merged"
      #       cat results/mochawesome.json | jq '.stats'
      #     else
      #       echo "‚ö†Ô∏è No mochawesome files found"
      #       echo '{"stats":{"tests":0,"passes":0,"failures":0,"pending":0,"duration":0},"results":[]}' \
      #         > results/mochawesome.json
      #     fi

      # ============================================================
      # ‚úÖ ALLURE ‚Äî generate report, simpan sebagai artifact 30 hari
      # Download dari: Actions tab ‚Üí pilih run ‚Üí Artifacts section
      # ============================================================
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline
          if [ -d allure-results ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            allure generate allure-results --clean -o allure-report
            echo "‚úÖ Allure report generated"
          else
            echo "‚ö†Ô∏è No allure results, skipping"
          fi

      - name: Upload Allure Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-run-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      - name: Remove ANSI color codes
        if: always()
        run: |
          sed -r "s/\x1B\[[0-9;]*[mK]//g" cypress-output.txt > clean-output.txt

      # ============================================================
      # ‚úÖ EXTRACT SUMMARY ‚Äî dari mochawesome (fresh, results dibersihkan sebelum run)
      # Duration dari GitHub Actions timestamp
      # ============================================================
      - name: Extract test summary
        if: always()
        run: |

          JOB_END_TIME=$(date +%s)
          DURATION_SEC=$(( JOB_END_TIME - JOB_START_TIME ))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))

          # OUTPUT_FILE="cypress-output.txt"
          OUTPUT_FILE="clean-output.txt"

          # ======================================
          # AMBIL SUMMARY TERAKHIR (PALING BAWAH)
          # ======================================
          PASSING=$(grep -oE '[0-9]+ passing' $OUTPUT_FILE | tail -1 | awk '{print $1}')
          FAILING=$(grep -oE '[0-9]+ failing' $OUTPUT_FILE | tail -1 | awk '{print $1}')

          PASSING=${PASSING:-0}
          FAILING=${FAILING:-0}

          TOTAL_TESTS=$((PASSING + FAILING))
          PASSED_TESTS=$PASSING
          FAILED_TESTS=$FAILING

          # ======================================
          # FAILED TEST LIST (CYPRESS v13 SAFE)
          # ======================================
          FAILED_TEST_DETAILS=$(grep "‚úñ" $OUTPUT_FILE \
            | grep ".cy." \
            | sed 's/\x1b\[[0-9;]*m//g' \
            | awk '{print $3}' \
            | sed 's/^/‚Ä¢ /')

          # ======================================
          # PASS RATE
          # ======================================
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSED_TESTS * 100 / $TOTAL_TESTS" | bc)
          else
            PASS_RATE="0"
          fi

          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV
          echo "PASS_RATE=${PASS_RATE}%" >> $GITHUB_ENV

          # üìä Stats langsung dari merged mochawesome (data fresh run ini)
          # if [ -f results/mochawesome.json ]; then
          #   TOTAL_TESTS=$(jq '.stats.tests // 0' results/mochawesome.json 2>/dev/null || echo 0)
          #   FAILED_TESTS=$(jq '.stats.failures // 0' results/mochawesome.json 2>/dev/null || echo 0)
          #   PASSED_TESTS=$(jq '.stats.passes // 0' results/mochawesome.json 2>/dev/null || echo 0)
          #   PENDING_TESTS=$(jq '.stats.pending // 0' results/mochawesome.json 2>/dev/null || echo 0)
          # else
          #   TOTAL_TESTS=0; FAILED_TESTS=0; PASSED_TESTS=0; PENDING_TESTS=0
          # fi

          # Bersihkan quote dari output jq
          # TOTAL_TESTS=$(echo "$TOTAL_TESTS" | tr -d '"')
          # FAILED_TESTS=$(echo "$FAILED_TESTS" | tr -d '"')
          # PASSED_TESTS=$(echo "$PASSED_TESTS" | tr -d '"')
          # PENDING_TESTS=$(echo "$PENDING_TESTS" | tr -d '"')

          # Pass rate
          # if [ "${TOTAL_TESTS:-0}" -gt 0 ] 2>/dev/null; then
          #   PASS_RATE=$(echo "scale=1; $PASSED_TESTS * 100 / $TOTAL_TESTS" | bc)
          # else
          #   PASS_RATE="0"
          # fi

          # echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          # echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          # echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          # echo "PENDING_TESTS=$PENDING_TESTS" >> $GITHUB_ENV

          # echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          # echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          # echo "EOF" >> $GITHUB_ENV

          # echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV
          # echo "PASS_RATE=${PASS_RATE}%" >> $GITHUB_ENV

      # - name: Extract failed tests
      #   if: always()
      #   run: |
      #     FAILED_TEST_DETAILS=""

      #     # ‚úÖ Ambil failed test dari mochawesome (fresh, sinkron dengan run ini)
      #     if [ -f results/mochawesome.json ]; then
      #       FAILED_TEST_DETAILS=$(jq -r \
      #         '[ .. | objects | select(.fail == true and .fullTitle?) | .fullTitle ] | unique[] | "‚Ä¢ " + .' \
      #         results/mochawesome.json 2>/dev/null || echo "")
      #     fi

      #     echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
      #     echo "$FAILED_TEST_DETAILS"     >> $GITHUB_ENV
      #     echo "EOF"                      >> $GITHUB_ENV

      # - name: Prepare failed display
      #   if: always()
      #   run: |
      #     if [ "$FAILED_TESTS" != "0" ]; then
      #       FAILED_DISPLAY="‚ùå Ada test yang gagal ‚Äî lihat Cypress Cloud"
      #     else
      #       FAILED_DISPLAY="‚úÖ Semua test passed!"
      #     fi

      #     echo "FAILED_DISPLAY=$FAILED_DISPLAY" >> $GITHUB_ENV

      # ============================================================
      # ‚úÖ DISCORD NOTIFICATION
      # Link langsung ke Cypress Cloud + Allure artifact
      # ============================================================
      - name: Send Discord Notification
        if: always()
        run: |

          # ================================
          # EXECUTION TIME
          # ================================
          EXEC_TIME=$(date "+Today at %I:%M %p")

          # ================================
          # STATUS
          # ================================
          if [ "$FAILED_TESTS" != "0" ]; then
            STATUS="failed"
            ICON="‚ùå"
            COLOR=15158332
            RESULT_LINE="‚ùå $FAILED_TESTS test failed"
          else
            STATUS="passed"
            ICON="‚úÖ"
            COLOR=3066993
            RESULT_LINE="‚úî $TOTAL_TESTS test results"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CLOUD_URL="https://cloud.cypress.io/projects/wipkva/runs"

          # ================================
          # FAILED TEST LIST
          # ================================
          if [ "$FAILED_TESTS" != "0" ]; then
            FAILED_SECTION="Failed Tests:\n$FAILED_TEST_DETAILS\n\nüîç View Detail ‚Üí $CLOUD_URL"
          else
            FAILED_SECTION=""
          fi

          # ================================
          # MESSAGE BODY
          # ================================
          DESCRIPTION=$(cat <<EOF
            Test Run #${{ github.run_number }} has $STATUS.

          üì¶ Suite : $TEST_SUITE
          üóì Executed : $EXEC_TIME
          ‚è± Duration : $TEST_DURATION
          $RESULT_LINE

          $FAILED_SECTION

          Project : ${{ github.repository }}"

          GitHub Actions ‚Ä¢ Cypress Cloud ‚Ä¢ Run #${{ github.run_number }} ‚Ä¢ $EXEC_TIME"

          jq -n \
            --arg title "$ICON Automation Report Cypress" \
            --arg desc "$DESCRIPTION" \
            --argjson color $COLOR \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                timestamp: (now | todateiso8601)
              }]
            }' \
          | curl -s -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}