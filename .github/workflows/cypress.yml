name: Cypress Automation Test

on:
  # üöÄ Push ke main ‚Üí trigger (merge dari QA branch setelah fix)
  push:
    branches: [ main ]

  # üîÄ Pull Request ke main ‚Üí trigger saat QA buat PR dari branch fix
  pull_request:
    branches: [ main ]

  # üñê Manual trigger
  workflow_dispatch:

  # ‚úÖ STEP 2 ‚Äî SCHEDULER (DITAMBAHKAN DI SINI)
  schedule:
   #- cron: '0 1 * * *'   # 08:00 WIB (UTC+7)
   #- cron: '40 20 * * *'
     #- cron: '0 18 * * 0-4'
      - cron: '*/5 * * * *'


jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect trigger & start time
        run: |
          echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV
          echo "JOB_START_TIME=$(date +%s)"       >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install project dependencies
        run: npm ci

      # ============================================================
      # RUN CYPRESS ‚Äî tee output ke file untuk parsing
      # ============================================================
      - name: Run Cypress Tests
        continue-on-error: true
        run: |
          npx cypress run \
            --record \
            --key ${{ secrets.CYPRESS_RECORD_KEY }} \
            2>&1 | tee cypress-raw.txt

      - name: Strip ANSI color codes
        if: always()
        run: sed 's/\x1B\[[0-9;]*[mKHF]//g' cypress-raw.txt > cypress-output.txt

      # ============================================================
      # ALLURE
      # ============================================================
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline --quiet
          if [ -d allure-results ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            allure generate allure-results --clean -o allure-report
          fi

      - name: Upload Allure Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      # ============================================================
      # EXTRACT STATS
      # ============================================================
      - name: Extract test summary
        if: always()
        run: |
          # Duration
          JOB_END_TIME=$(date +%s)
          DURATION_SEC=$(( JOB_END_TIME - JOB_START_TIME ))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))

          # Ambil grand total dari section "Results:" di bagian akhir output Cypress
          # Cypress sudah hitung total ‚Äî kita tinggal ambil dari sana
          IN_RESULTS=0
          PASSING=0; FAILING=0; PENDING=0
          while IFS= read -r line; do
            if echo "$line" | grep -qE '^\s+Tests:\s+[0-9]+'; then
              IN_RESULTS=1
            fi
            if [ "$IN_RESULTS" = "1" ]; then
              if echo "$line" | grep -qE '^\s+Passing:'; then
                PASSING=$(echo "$line" | grep -oE '[0-9]+' | head -1)
              fi
              if echo "$line" | grep -qE '^\s+Failing:'; then
                FAILING=$(echo "$line" | grep -oE '[0-9]+' | head -1)
              fi
              if echo "$line" | grep -qE '^\s+Pending:'; then
                PENDING=$(echo "$line" | grep -oE '[0-9]+' | head -1)
              fi
            fi
          done < cypress-output.txt

          # Fallback: kalau Results block tidak ada, ambil baris terakhir passing/failing
          if [ "${PASSING:-0}" = "0" ] && [ "${FAILING:-0}" = "0" ]; then
            PASSING=$(grep -E '^\s+[0-9]+ passing' cypress-output.txt | tail -1 | grep -oE '[0-9]+' | head -1)
            FAILING=$(grep -E '^\s+[0-9]+ failing' cypress-output.txt | tail -1 | grep -oE '[0-9]+' | head -1)
            PENDING=$(grep -E '^\s+[0-9]+ pending' cypress-output.txt | tail -1 | grep -oE '[0-9]+' | head -1)
          fi

          PASSING=${PASSING:-0}
          FAILING=${FAILING:-0}
          PENDING=${PENDING:-0}
          TOTAL=$(( PASSING + FAILING + PENDING ))

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSING * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0"
          fi

          # Suite name: nama file spec tanpa path dan .cy.js
          SUITE_LIST=$(grep -oE 'Running:  [^ ]+' cypress-output.txt \
            | sed 's/Running:  //' \
            | sed 's|.*/||' \
            | sed 's/\.cy\.js$//' \
            | sort -u \
            | tr '\n' ', ' \
            | sed 's/, $//')

          echo "TOTAL_TESTS=$TOTAL"                    >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSING"                 >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILING"                 >> $GITHUB_ENV
          echo "PENDING_TESTS=$PENDING"                >> $GITHUB_ENV
          echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV
          echo "PASS_RATE=${PASS_RATE}%"               >> $GITHUB_ENV
          echo "SUITE_LIST=$SUITE_LIST"                >> $GITHUB_ENV

          echo "=== SUMMARY ==="
          echo "Total=$TOTAL | Passed=$PASSING | Failed=$FAILING | Pending=$PENDING | Duration=${MINUTES}m ${SECONDS}s"
          echo "Suite: $SUITE_LIST"

      - name: Extract failed test names
        if: always()
        run: |
          # Cypress output format untuk failed tests:
          #   1) Suite Name
          #        test title
          FAILED_LIST=$(awk '
            /^[[:space:]]+[0-9]+\)/ { capture=1; next }
            capture==1 && /^[[:space:]]+[^[:space:]]/ {
              line=$0
              gsub(/^[[:space:]]+/, "", line)
              gsub(/:$/, "", line)
              print "‚Ä¢ " line
              capture=0
            }
            /^[[:space:]]*$/ { capture=0 }
          ' cypress-output.txt | sort -u | head -20)

          echo "=== FAILED LIST DEBUG ==="
          echo "$FAILED_LIST"

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_LIST"             >> $GITHUB_ENV
          echo "EOF"                      >> $GITHUB_ENV

      # ============================================================
      # DISCORD NOTIFICATION ‚Äî format mirip Katalon
      # ============================================================
      - name: Send Discord Notification
        if: always()
        run: |
          EXEC_TIME=$(TZ='Asia/Jakarta' date "+%Y-%m-%d %I:%M:%S %p")

          TOTAL=${TOTAL_TESTS:-0}
          PASSED=${PASSED_TESTS:-0}
          FAILED=${FAILED_TESTS:-0}

          if [ "$FAILED" != "0" ]; then
            STATUS_TEXT="has failed"
            RESULT_ICON="‚ùå"
            COLOR=15158332
          else
            STATUS_TEXT="has passed"
            RESULT_ICON="‚úÖ"
            COLOR=3066993
          fi

          case "$TRIGGER" in
            schedule)          TRIGGER_LABEL="Scheduled"    ;;
            push)              TRIGGER_LABEL="Push to main" ;;
            pull_request)      TRIGGER_LABEL="Pull Request" ;;
            workflow_dispatch) TRIGGER_LABEL="Manual"       ;;
            *)                 TRIGGER_LABEL="$TRIGGER"     ;;
          esac

          if [ "$TRIGGER" = "pull_request" ]; then
            BRANCH_INFO="PR #${{ github.event.pull_request.number }} (${{ github.head_ref }})"
          else
            BRANCH_INFO="${{ github.ref_name }}"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CLOUD_URL="https://cloud.cypress.io/projects/wipkva/runs"
          ARTIFACT_URL="${RUN_URL}#artifacts"
          REPO="${{ github.repository }}"
          REPO_NAME="${REPO##*/}"

          SUITE_NAME="${SUITE_LIST:-${{ github.ref_name }}}"

          # Build body
          DESC="Test Run [#${{ github.run_number }}]($RUN_URL) of the **${REPO_NAME}** ${STATUS_TEXT}."
          LINE2="üì¶ ${SUITE_NAME}"
          LINE3="üïê ${EXEC_TIME} (${TEST_DURATION})"
          LINE4="${RESULT_ICON} ${TOTAL} test results"

          if [ "$FAILED" != "0" ]; then
            if [ -n "$FAILED_TEST_DETAILS" ]; then
              LINE5="${FAILED} test results failed
            ${FAILED_TEST_DETAILS}"
                        else
                          LINE5="${FAILED} test results failed"
                        fi
                        BODY="${DESC}

            ${LINE2}
            ${LINE3}
            ${LINE4}

            ${LINE5}"
                      else
                        BODY="${DESC}

            ${LINE2}
            ${LINE3}
            ${LINE4}"
                      fi

                      FOOTER="${REPO} | ${BRANCH_INFO} | ${TRIGGER_LABEL}"

                      jq -n \
                        --arg body        "$BODY" \
                        --arg footer      "$FOOTER" \
                        --arg cloudUrl    "$CLOUD_URL" \
                        --arg artifactUrl "$ARTIFACT_URL" \
                        --argjson color   $COLOR \
                      '{
                        embeds: [{
                          description: $body,
                          color: $color,
                          fields: [
                            { name: "‚òÅÔ∏è Cypress Cloud", value: ("[Open Dashboard ‚Üí](" + $cloudUrl + ")"),       inline: true },
                            { name: "üì¶ Allure Report", value: ("[Download Artifact ‚Üí](" + $artifactUrl + ")"), inline: true }
                          ],
                          footer: { text: $footer },
                          timestamp: (now | todateiso8601)
                        }]
                      }' \
                      | curl -s -H "Content-Type: application/json" \
                          -X POST \
                          -d @- \
                          ${{ secrets.DISCORD_WEBHOOK }}