name: Cypress Automation Test (Docker)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  cypress-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect trigger
        run: echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build Docker image
        run: docker build -t cypress-test .

      # ‚úÖ RUN CYPRESS + MOCHAWESOME + ALLURE + CYPRESS CLOUD
      - name: Run Cypress tests (Docker)
        continue-on-error: true
        run: |
          mkdir -p results allure-results
          docker run --rm \
            -e CYPRESS_RECORD_KEY=${{ secrets.CYPRESS_RECORD_KEY }} \
            -v ${{ github.workspace }}:/app \
            -w /app \
            cypress/included:13.6.6 \
            cypress run \
            --record \
            --env allure=true,allureResultsPath=allure-results \
            --reporter mochawesome \
            --reporter-options reportDir=results,overwrite=false,html=false,json=true

      - name: Debug results folder
        if: always()
        run: |
          echo "=== results folder ==="
          ls -lah results || true
          echo "=== allure-results folder ==="
          ls -lah allure-results || true

      - name: Remove empty mochawesome files
        run: find results -type f -name "*.json" -size 0 -delete

      - name: Merge mochawesome reports
        run: |
          ls results/mochawesome_*.json
          npx mochawesome-merge results/mochawesome_*.json > results/mochawesome.json

      - name: Debug merged report
        run: cat results/mochawesome.json | jq '.stats'

      # ‚úÖ GENERATE ALLURE REPORT
      - name: Generate Allure Report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report

      # ‚úÖ UPLOAD ALLURE AS ARTIFACT (always accessible)
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      # ‚úÖ OPTIONAL: Publish Allure to GitHub Pages
      # Requires: Settings ‚Üí Pages ‚Üí Source: gh-pages branch
      # Requires: Settings ‚Üí Actions ‚Üí Workflow permissions: Read and write
      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: allure/${{ github.run_number }}
          keep_files: true

      # ‚úÖ EXTRACT SUMMARY
      - name: Extract test summary
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then
            TOTAL_TESTS=$(jq '.stats.tests' results/mochawesome.json)
            FAILED_TESTS=$(jq '.stats.failures' results/mochawesome.json)
            PASSED_TESTS=$(jq '.stats.passes' results/mochawesome.json)
            DURATION_MS=$(jq '.stats.duration' results/mochawesome.json)
          else
            TOTAL_TESTS=0
            FAILED_TESTS=0
            PASSED_TESTS=0
            DURATION_MS=0
          fi

          DURATION_SEC=$((DURATION_MS / 1000))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))
          DURATION_FORMATTED="${MINUTES}m ${SECONDS}s"

          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "TEST_DURATION=$DURATION_FORMATTED" >> $GITHUB_ENV

      # ‚úÖ EXTRACT FAILED TEST LIST
      - name: Extract failed tests
        if: always()
        run: |
          if [ -f results/mochawesome.json ]; then
            FAILED_TEST_DETAILS=$(jq -r '
              .results[].suites[].tests[]
              | select(.fail == true)
              | "- " + .fullTitle
            ' results/mochawesome.json)
          else
            FAILED_TEST_DETAILS="None"
          fi

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ‚úÖ SEND DISCORD EMBED NOTIFICATION (with Allure link)
      - name: Send Discord Embed Notification
        if: always()
        run: |
          if [ "$FAILED_TESTS" != "0" ]; then
            STATUS="FAILED"
            COLOR=15158332
            ICON="‚ùå"
          else
            STATUS="SUCCESS"
            COLOR=3066993
            ICON="‚úÖ"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Allure report URL (GitHub Pages) ‚Äî sesuaikan dengan repo kamu
          ALLURE_URL="https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/allure/${{ github.run_number }}"

          jq -n \
            --arg trigger "$TRIGGER" \
            --arg runNumber "${{ github.run_number }}" \
            --arg runAttempt "${{ github.run_attempt }}" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status "$STATUS" \
            --arg total "$TOTAL_TESTS" \
            --arg passed "$PASSED_TESTS" \
            --arg failed "$FAILED_TESTS" \
            --arg duration "$TEST_DURATION" \
            --arg url "$RUN_URL" \
            --arg allureUrl "$ALLURE_URL" \
            --arg icon "$ICON" \
            --arg failedDetails "$FAILED_TEST_DETAILS" \
            --argjson color $COLOR \
          '{
            embeds: [
              {
                title: "üß™ Cypress Automation Report",
                url: $url,
                color: $color,
                fields: [
                  {name: "Trigger",     value: $trigger,                              inline: true},
                  {name: "Test Run",    value: ("#" + $runNumber + " (Attempt " + $runAttempt + ")"), inline: true},
                  {name: "Duration",    value: ("‚è± " + $duration),                   inline: true},
                  {name: "Repository",  value: $repo,                                 inline: true},
                  {name: "Branch",      value: $branch,                               inline: true},
                  {name: "Status",      value: ($icon + " " + $status),               inline: true},
                  {name: "Total Tests", value: $total,                                inline: true},
                  {name: "Passed",      value: $passed,                               inline: true},
                  {name: "Failed",      value: $failed,                               inline: true},
                  {name: "üìä Allure Report", value: ("[View Report](" + $allureUrl + ")"), inline: false},
                  {
                    name: "‚ùó Failed Tests",
                    value: ($failedDetails | if . == "" then "None" else . end)
                  }
                ],
                footer: {
                  text: "GitHub Actions ‚Ä¢ Cypress Automation"
                },
                timestamp: (now | todateiso8601)
              }
            ]
          }' \
          | curl -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}