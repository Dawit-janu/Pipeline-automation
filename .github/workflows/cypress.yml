name: Cypress Automation Test (Docker)

on:
  push:
    branches: [ main ]

  pull_request:

  workflow_dispatch:

  schedule:
    - cron: '*/5 * * * *'

jobs:
  cypress-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect trigger
        run: echo "TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ‚úÖ INSTALL DEPENDENCY (WAJIB UNTUK MOCHAWESOME MERGE)
      - name: Install dependencies
        run: npm ci

      # ‚úÖ CYPRESS CLOUD RUN (INI KUNCI DASHBOARD)
      - name: Cypress Run
        id: cypress
        uses: cypress-io/github-action@v6
        with:
          record: true
          config-file: cypress.config.js
          ci-build-id: ${{ github.run_id }}
          group: ${{ github.event_name }}
          command: >
            npx cypress run
            --reporter mochawesome
            --reporter-options reportDir=results,overwrite=false,html=false,json=true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

      # =============================
      # REPORT PROCESSING
      # =============================

      - name: Remove empty mochawesome files
        if: always()
        run: find results -type f -name "*.json" -size 0 -delete || true

      - name: Merge mochawesome reports
        if: always()
        run: |
          npx mochawesome-merge results/*.json > results/mochawesome.json

      - name: Extract test summary
        if: always()
        run: |
          TOTAL_TESTS=$(jq '.stats.tests' results/mochawesome.json)
          FAILED_TESTS=$(jq '.stats.failures' results/mochawesome.json)
          PASSED_TESTS=$(jq '.stats.passes' results/mochawesome.json)
          DURATION_MS=$(jq '.stats.duration' results/mochawesome.json)

          DURATION_SEC=$((DURATION_MS / 1000))
          MINUTES=$((DURATION_SEC / 60))
          SECONDS=$((DURATION_SEC % 60))

          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
          echo "TEST_DURATION=${MINUTES}m ${SECONDS}s" >> $GITHUB_ENV

      - name: Extract failed tests
        if: always()
        run: |
          FAILED_TEST_DETAILS=$(jq -r '
            .results[].suites[].tests[]
            | select(.fail == true)
            | "- " + .fullTitle
          ' results/mochawesome.json)

          echo "FAILED_TEST_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$FAILED_TEST_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # =============================
      # DISCORD REPORT
      # =============================

      - name: Send Discord Embed Notification
        if: always()
        run: |

          if [ "$FAILED_TESTS" != "0" ]; then
            STATUS="FAILED"
            COLOR=15158332
            ICON="‚ùå"
          else
            STATUS="SUCCESS"
            COLOR=3066993
            ICON="‚úÖ"
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CYPRESS_URL="https://cloud.cypress.io/projects/wipkva/runs/${{ github.run_id }}"

          jq -n \
            --arg trigger "$TRIGGER" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg status "$STATUS" \
            --arg total "$TOTAL_TESTS" \
            --arg passed "$PASSED_TESTS" \
            --arg failed "$FAILED_TESTS" \
            --arg duration "$TEST_DURATION" \
            --arg url "$RUN_URL" \
            --arg dashboard "$CYPRESS_URL" \
            --arg icon "$ICON" \
            --arg failedDetails "$FAILED_TEST_DETAILS" \
            --argjson color $COLOR \
          '{
            embeds: [{
              title: "üß™ Cypress Automation Report",
              url: $url,
              color: $color,
              fields: [
                {name:"Trigger",value:$trigger,inline:true},
                {name:"Repository",value:$repo,inline:true},
                {name:"Branch",value:$branch,inline:true},
                {name:"Status",value:($icon+" "+$status),inline:true},
                {name:"Duration",value:$duration,inline:true},
                {name:"Total",value:$total,inline:true},
                {name:"Passed",value:$passed,inline:true},
                {name:"Failed",value:$failed,inline:true},
                {
                  name:"üîé Cypress Dashboard",
                  value:("[Open Run]("+$dashboard+")")
                },
                {
                  name:"‚ùó Failed Tests",
                  value:($failedDetails | if .=="" then "None" else . end)
                }
              ],
              footer:{text:"GitHub Actions ‚Ä¢ Cypress Automation"},
              timestamp:(now|todateiso8601)
            }]
          }' \
          | curl -H "Content-Type: application/json" \
              -X POST \
              -d @- \
              ${{ secrets.DISCORD_WEBHOOK }}